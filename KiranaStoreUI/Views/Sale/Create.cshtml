@model KiranaStoreUI.Models.ViewModels.SaleCustomerVM

<div class="container mt-4">

    <h2 class="text-success fw-bold mb-4">➕ Add Sale & Customer</h2>

    <div class="card shadow border-0">
        <div class="card-body p-4">

            <form method="post" id="saleForm">

                <div asp-validation-summary="All" class="alert alert-danger"></div>

                <!-- 🔥 IMPORTANT -->
                <input asp-for="Customer.CustomerId" type="hidden" />

                <div class="row">

                    <!-- SALE DETAILS -->
                    <div class="col-md-6">
                        <h4 class="text-primary mb-3">Sale Details</h4>

                        <div class="mb-3">
                            <label>Invoice Number</label>
                            <input asp-for="Sale.InvoiceNumber" class="form-control" readonly />
                        </div>

                        <div class="mb-3">
                            <label>Total Amount</label>
                            <input asp-for="Sale.TotalAmount" id="total"
                                   class="form-control text-end fw-bold" readonly />
                        </div>

                        <div class="mb-3">
                            <label>Discount</label>
                            <input asp-for="Sale.Discount" id="discount"
                                   class="form-control text-end" />
                        </div>

                        <div class="mb-3">
                            <label>Net Amount</label>
                            <input asp-for="Sale.NetAmount" id="net"
                                   class="form-control fw-bold text-success text-end" readonly />
                        </div>

                        <div class="mb-3">
                            <label>Payment Mode</label>
                            <select asp-for="Sale.PaymentMode" class="form-select">
                                <option>Cash</option>
                                <option>UPI</option>
                                <option>Card</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Sale Date</label>
                            <input asp-for="Sale.SaleDate" type="date" class="form-control" />
                        </div>
                    </div>

                    <!-- CUSTOMER + PRODUCT -->
                    <div class="col-md-6">
                        <h4 class="text-primary mb-3">Customer Details</h4>

                        <div class="mb-3">
                            <label>Name</label>
                            <input asp-for="Customer.Name" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label>Phone</label>
                            <input asp-for="Customer.Phone" class="form-control" />
                        </div>

                        <hr />

                        <label>Search Product</label>
                        <input type="text" id="productSearch"
                               class="form-control"
                               placeholder="Type product name..." />

                        <div id="searchResult"
                             class="list-group mt-2"
                             style="display:none;"></div>

                        <hr />

                        <h6 class="fw-bold">Selected Products</h6>
                        <ul id="selectedProducts" class="list-group"></ul>
                    </div>

                </div>

                <hr />
                <button class="btn btn-success">Submit</button>
                <a href="/Sale/Index" class="btn btn-secondary">Back</a>
            </form>
        </div>
    </div>
</div>

<script>
    const total = document.getElementById("total");
    const discount = document.getElementById("discount");
    const net = document.getElementById("net");

    discount.addEventListener("input", () => {
        net.value = (parseFloat(total.value || 0) - parseFloat(discount.value || 0)).toFixed(2);
    });

    let selectedProducts = [];

    // 🔍 SEARCH PRODUCT
    document.getElementById("productSearch").addEventListener("keyup", function () {
        let q = this.value.trim();
        if (q.length < 2) return;

        fetch(`/Sale/SearchProduct?keyword=${q}`)
            .then(r => r.json())
            .then(d => {
                let box = document.getElementById("searchResult");
                box.innerHTML = "";
                box.style.display = "block";

                d.products.forEach(p => {
                    box.innerHTML += `
                    <a class="list-group-item"
                       onclick="addProduct(${p.productId}, '${p.productName}', ${p.sellingPrice})">
                        ${p.productName} - ₹${p.sellingPrice}/Kg
                    </a>`;
                });
            });
    });

    // ➕ ADD PRODUCT
    function addProduct(id, name, price) {
        selectedProducts.push({
            id,
            name,
            price,
            qty: 1,
            unit: "Kg"
        });
        render();
        document.getElementById("searchResult").style.display = "none";
        document.getElementById("productSearch").value = "";
    }

    // 🧮 CALCULATIONS
    function calcItem(p) {
        let kgQty = p.unit === "Gram" ? p.qty / 1000 : p.qty;
        return kgQty * p.price;
    }

    function render() {
        let ul = document.getElementById("selectedProducts");
        ul.innerHTML = "";
        let sum = 0;

        selectedProducts.forEach(p => {
            let itemTotal = calcItem(p);
            sum += itemTotal;

            ul.innerHTML += `
            <li class="list-group-item">
                <b>${p.name}</b>
                <div class="row mt-2">
                    <div class="col-4">
                        <input type="number" step="0.01"
                               class="form-control"
                               value="${p.qty}"
                               onchange="pQty(${p.id}, this.value)">
                    </div>
                    <div class="col-3">
                        <select class="form-select"
                                onchange="pUnit(${p.id}, this.value)">
                            <option ${p.unit=="Kg"?"selected":""}>Kg</option>
                            <option ${p.unit=="Gram"?"selected":""}>Gram</option>
                            <option ${p.unit=="Pice"?"selected":""}></option>
                        </select>
                    </div>
                    <div class="col-3 fw-bold text-end">
                        ₹${itemTotal.toFixed(2)}
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="removeP(${p.id})">X</button>
                    </div>
                </div>
            </li>`;
        });

        total.value = sum.toFixed(2);
        net.value = (sum - (discount.value || 0)).toFixed(2);
    }

    function pQty(id, qty) {
        selectedProducts.find(x => x.id === id).qty = parseFloat(qty);
        render();
    }

    function pUnit(id, u) {
        selectedProducts.find(x => x.id === id).unit = u;
        render();
    }

    function removeP(id) {
        selectedProducts = selectedProducts.filter(x => x.id !== id);
        render();
    }

    // 📤 SUBMIT
    document.getElementById("saleForm").addEventListener("submit", function () {

        if (selectedProducts.length === 0) {
            alert("Please select at least one product");
            event.preventDefault();
            return;
        }

        selectedProducts.forEach((p, i) => {

            let qtyInKg = p.unit === "Gram" ? p.qty / 1000 : p.qty;

            this.appendChild(hidden(`Sale.SaleItems[${i}].ProductId`, p.id));
            this.appendChild(hidden(`Sale.SaleItems[${i}].Quantity`, qtyInKg));
            this.appendChild(hidden(`Sale.SaleItems[${i}].Price`, p.price));
            this.appendChild(hidden(`Sale.SaleItems[${i}].Total`, qtyInKg * p.price));
        });
    });

    function hidden(n, v) {
        let i = document.createElement("input");
        i.type = "hidden";
        i.name = n;
        i.value = v;
        return i;
    }
</script>

