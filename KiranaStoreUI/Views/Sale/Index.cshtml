@model List<KiranaStoreUI.Models.Sale>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-success m-0">Sales List</h2>

        <a href="/Sale/Create" class="btn btn-success shadow fw-bold">
            + Add New Sale
        </a>
    </div>

    <div class="card shadow border-0">

        <div class="card-header bg-success text-light fw-bold">
            Sales Records
        </div>

        <!-- 🌟 SEARCH + FILTER BAR -->
        <div class="p-3 border-bottom bg-light">

            <div class="row g-2">

                <!-- Search Box -->
                <div class="col-md-6">
                    <input type="text" id="searchBox" class="form-control shadow-sm"
                           placeholder="🔍 Search Invoice, Customer, Payment Mode, Date..." />
                </div>

                <!-- Filter: Payment Mode -->
                <div class="col-md-3">
                    <select id="paymentFilter" class="form-select shadow-sm">
                        <option value="">Filter by Payment Mode</option>
                        <option>Cash</option>
                        <option>UPI</option>
                        <option>Card</option>
                        <option>Credit</option>
                    </select>
                </div>

                <!-- Filter: Date -->
                <div class="col-md-3">
                    <input type="date" id="dateFilter" class="form-control shadow-sm" />
                </div>

            </div>

        </div>
        <!-- END SEARCH BAR -->

        <div class="card-body p-0">

            <table class="table table-hover table-bordered mb-0">

                <thead class="table-success sticky-top" style="top:0; z-index:1;">
                    <tr class="text-center">
                        <th>Invoice</th>
                        <th>Customer Name</th>
                        <th>Total (₹)</th>
                        <th>Discount (₹)</th>
                        <th>Net (₹)</th>
                        <th>Payment Mode</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var s in Model)
                        {
                            <tr>
                                <td class="fw-bold text-primary">@s.InvoiceNumber</td>

                                <td>
                                    @if (s.Customer != null)
                                    {
                                        @s.Customer.Name
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td class="text-end fst-italic fw-bold text-dark">
                                    ₹ @s.TotalAmount.ToString("0.00")
                                </td>

                                <td class="text-end text-danger">
                                    ₹ @s.Discount.ToString("0.00")
                                </td>

                                <td class="text-end fw-bold text-success">
                                    ₹ @s.NetAmount.ToString("0.00")
                                </td>

                                <td>@s.PaymentMode</td>
                                <td>@s.SaleDate.ToString("dd-MMM-yyyy")</td>

                                <td class="text-center">
                                    <a href="/Sale/Details/@s.SaleId" class="btn btn-primary btn-sm">View</a>
                                    <a href="/Sale/Edit/@s.SaleId" class="btn btn-warning btn-sm">Edit</a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-3">
                                No sales found
                            </td>
                        </tr>
                    }
                </tbody>

            </table>

        </div>

    </div>

</div>


<!-- 🌟 FILTER SCRIPT -->
<script>
    const searchBox = document.getElementById("searchBox");
    const paymentFilter = document.getElementById("paymentFilter");
    const dateFilter = document.getElementById("dateFilter");

    function filterTable() {
        let search = searchBox.value.toLowerCase();
        let payment = paymentFilter.value.toLowerCase();
        let date = dateFilter.value;

        let rows = document.querySelectorAll("table tbody tr");

        rows.forEach(row => {
            let invoice = row.children[0].innerText.toLowerCase();
            let customer = row.children[1].innerText.toLowerCase();
            let paymentMode = row.children[5].innerText.toLowerCase();
            let saleDate = row.children[6].innerText;

            // Convert dd-MMM-yyyy to yyyy-MM-dd
            let formattedDate = new Date(saleDate).toISOString().split('T')[0];

            let match =
                (invoice.includes(search) ||
                 customer.includes(search) ||
                 paymentMode.includes(search) ||
                 saleDate.toLowerCase().includes(search)) &&

                (payment === "" || paymentMode.includes(payment)) &&

                (date === "" || formattedDate === date);

            row.style.display = match ? "" : "none";
        });
    }

    searchBox.addEventListener("keyup", filterTable);
    paymentFilter.addEventListener("change", filterTable);
    dateFilter.addEventListener("change", filterTable);
</script>
