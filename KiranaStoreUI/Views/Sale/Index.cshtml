@model List<KiranaStoreUI.Models.Sale>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-success m-0">Sales List</h2>

        <a href="/Sale/Create" class="btn btn-success shadow fw-bold">
            + Add New Sale
        </a>
    </div>

    <div class="card shadow border-0">

        <div class="card-header bg-success text-light fw-bold">
            Sales Records
        </div>

        <!-- 🌟 SEARCH + FILTER BAR -->
        <div class="p-3 border-bottom bg-light">

            <div class="row g-2">

                <!-- Search Box -->
                <div class="col-md-6">
                    <input type="text" id="searchBox" class="form-control shadow-sm"
                           placeholder="🔍 Search Invoice, Customer, Payment Mode, Date..." />
                </div>

                <!-- Filter: Payment Mode -->
                <div class="col-md-3">
                    <select id="paymentFilter" class="form-select shadow-sm">
                        <option value="">Filter by Payment Mode</option>
                        <option>Cash</option>
                        <option>UPI</option>
                        <option>Card</option>
                        <option>Credit</option>
                    </select>
                </div>

                <!-- Filter: Date -->
                <div class="col-md-3">
                    <input type="date" id="dateFilter" class="form-control shadow-sm" />
                </div>

            </div>

        </div>
        <!-- END SEARCH BAR -->

        <div class="card mt-4 shadow-sm border-0">
            <div class="card-body bg-light rounded-3">

                <div class="d-flex align-items-center justify-content-between flex-wrap">

                    <!-- LEFT: TITLE + DATE -->
                    <div class="mb-2">
                        <h5 class="fw-bold text-success mb-1">
                            📅 Date Wise Sale Summary
                        </h5>

                        <small class="text-muted">
                            Selected Date:
                            <span id="selectedDateText" class="fw-semibold text-dark">—</span>
                        </small>
                    </div>

                    <!-- RIGHT: TOTAL AMOUNT -->
                    <div class="text-end">
                        <div class="text-muted small">Total Net Sale</div>
                        <div class="fs-4 fw-bold text-success">
                            ₹ <span id="dateWiseTotal">0.00</span>
                        </div>
                    </div>

                </div>

            </div>
        </div>




        <div class="card-body p-0">

            <table class="table table-hover table-bordered mb-0">

                <thead class="table-success sticky-top" style="top:0; z-index:1;">
                    <tr class="text-center">
                        <th>Invoice</th>
                        <th>Customer Name</th>
                        <th>Total (₹)</th>
                        <th>Discount (₹)</th>
                        <th>Net (₹)</th>
                        <th>Payment Mode</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var s in Model)
                        {
                            <tr>
                                <td class="fw-bold text-primary">@s.InvoiceNumber</td>

                                <td>
                                    @if (s.Customer != null)
                                    {
                                        @s.Customer.Name
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>

                                <td class="text-end fst-italic fw-bold text-dark">
                                    ₹ @s.TotalAmount.ToString("0.00")
                                </td>

                                <td class="text-end text-danger">
                                    ₹ @s.Discount.ToString("0.00")
                                </td>

                                <td class="text-end fw-bold text-success">
                                    ₹ @s.NetAmount.ToString("0.00")
                                </td>

                                <td>@s.PaymentMode</td>
                                <td>@s.SaleDate.ToString("dd-MMM-yyyy")</td>

                                <td class="text-center">
                                    <a href="/Sale/Details/@s.SaleId" class="btn btn-primary btn-sm">View</a>
                                    <a href="/Sale/Edit/@s.SaleId" class="btn btn-warning btn-sm">Edit</a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-3">
                                No sales found
                            </td>
                        </tr>
                    }
                </tbody>

            </table>

        </div>

    </div>

</div>

<style>
    .card-body.bg-light {
        background: linear-gradient(135deg, #f8fdf9, #eefaf1);
    }
</style>


<script>
    const searchBox = document.getElementById("searchBox");
    const paymentFilter = document.getElementById("paymentFilter");
    const dateFilter = document.getElementById("dateFilter");

    const totalSpan = document.getElementById("dateWiseTotal");
    const selectedDateText = document.getElementById("selectedDateText");

    // Parse "04-Feb-2026"
    function parseCustomDate(text) {
        if (!text) return null;

        const parts = text.split("-");
        if (parts.length !== 3) return null;

        const day = parseInt(parts[0], 10);
        const year = parseInt(parts[2], 10);

        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const month = months.indexOf(parts[1]);

        if (month === -1) return null;

        return new Date(year, month, day);
    }

    function filterTable() {
        const search = (searchBox?.value || "").toLowerCase();
        const payment = (paymentFilter?.value || "").toLowerCase();
        const selectedDate = dateFilter?.value || "";

        const rows = document.querySelectorAll("table tbody tr");
        let totalNetAmount = 0;

        rows.forEach(row => {
            if (row.children.length < 7) return;

            const invoice = row.children[0].innerText.toLowerCase();
            const customer = row.children[1].innerText.toLowerCase();
            const netAmount = parseFloat(
                row.children[4].innerText.replace("₹", "").trim()
            ) || 0;
            const paymentMode = row.children[5].innerText.toLowerCase();
            const saleDateText = row.children[6].innerText;

            const saleDate = parseCustomDate(saleDateText);
            let formattedDate = "";

            if (saleDate) {
                formattedDate =
                    saleDate.getFullYear() + "-" +
                    String(saleDate.getMonth() + 1).padStart(2, "0") + "-" +
                    String(saleDate.getDate()).padStart(2, "0");
            }

            const match =
                (invoice.includes(search) ||
                 customer.includes(search) ||
                 paymentMode.includes(search)) &&
                (payment === "" || paymentMode.includes(payment)) &&
                (selectedDate === "" || formattedDate === selectedDate);

            row.style.display = match ? "" : "none";

            // ✅ CALCULATE TOTAL FOR ALL MATCHED ROWS
            if (match) {
                // If date selected → sum only that date
                if (!selectedDate || formattedDate === selectedDate) {
                    totalNetAmount += netAmount;
                }
            }
        });

        // Update UI
        if (totalSpan) totalSpan.innerText = totalNetAmount.toFixed(2);
        if (selectedDateText)
            selectedDateText.innerText = selectedDate || "Filtered Results";
    }

    if (searchBox) searchBox.addEventListener("keyup", filterTable);
    if (paymentFilter) paymentFilter.addEventListener("change", filterTable);
    if (dateFilter) dateFilter.addEventListener("change", filterTable);
</script>
