@model List<KiranaStoreUI.Models.Stock>

@{
    ViewData["Title"] = "Stock Chart";
}

<h2 class="mb-4 text-success">📊 Product Stock Levels</h2>

<div class="card shadow-sm border-0">
    <div class="card-body" style="position: relative; height: 400px;">
        <canvas id="stockChart" style="width:100%; height:100%;"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Labels = Product IDs
        const labels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(s => s.ProductId)));

        // Data = Quantities
        const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(s => s.Quantity)));

        // Define threshold for low stock
        const lowStockThreshold = 50;

        // Colors: Red for low stock, random greenish for sufficient stock
        const backgroundColors = data.map(qty =>
            qty < lowStockThreshold
                ? 'rgba(220, 53, 69, 0.7)'  // red for low stock
                : `rgba(${Math.floor(Math.random()*100 + 50)}, ${Math.floor(Math.random()*180 + 50)}, ${Math.floor(Math.random()*100 + 50)}, 0.7)`
        );

        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

        const ctx = document.getElementById('stockChart').getContext('2d');

        const stockChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Quantity in Stock',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    borderRadius: 9,  // rounded corners
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: { display: true, text: 'Product Stock Levels', font: { size: 18, weight: 'bold' } },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Product ID', font: { size: 14, weight: 'bold' } },
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Quantity', font: { size: 14, weight: 'bold' } },
                        ticks: { precision: 0 },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    </script>
}
